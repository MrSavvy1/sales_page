(function(){function byId(id){return document.getElementById(id)}
function parseList(csv){return(csv||'').split(',').map(s=>s.trim()).filter(Boolean)}
function parseLines(text){return(text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean)}
function lagosNow(){try{var now=new Date();var date=new Intl.DateTimeFormat('en-NG',{timeZone:'Africa/Lagos',year:'numeric',month:'2-digit',day:'2-digit'}).format(now);var time=new Intl.DateTimeFormat('en-NG',{timeZone:'Africa/Lagos',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:!1}).format(now);return{date:date,time:time}}catch(e){var d=new Date();return{date:d.toISOString().slice(0,10),time:d.toTimeString().slice(0,8)}}}
function fillSelect(el,options){el.innerHTML='<option value="">Select...</option>';options.forEach(function(opt){var o=document.createElement('option');o.value=opt;o.textContent=opt;el.appendChild(o)})}
function isValidNGPhone(v){var s=(v||'').replace(/\s+/g,'');return/^(\+?234\d{10}|0\d{10})$/.test(s)}
function buildFromTemplate(tpl,map){return tpl.replace(/\{(.*?)\}/g,function(_,key){return encodeURIComponent(map[key]!=null?String(map[key]):'')})}
function trapFocus(container){var selectors='a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';var focusable=container.querySelectorAll(selectors);if(!focusable.length)return function(){};var first=focusable[0],last=focusable[focusable.length-1];function handle(e){if(e.key==='Tab'){if(e.shiftKey&&document.activeElement===first){e.preventDefault();last.focus()}else if(!e.shiftKey&&document.activeElement===last){e.preventDefault();first.focus()}}else if(e.key==='Escape'){container.setAttribute('aria-hidden','true');if(container.id==='jgwo-form'){try{document.body.classList.remove('jgwo-lock')}catch(e){}}}}
container.addEventListener('keydown',handle);return function(){container.removeEventListener('keydown',handle)}}
var btn=byId('jgwo-order-button');var modal=byId('jgwo-confirm');var formPanel=byId('jgwo-form');try{if(modal&&modal.parentNode!==document.body){document.body.appendChild(modal)}}catch(e){}
if(!btn||!modal||!formPanel||!window.JGWO)return;var stateSelect=byId('jgwo-state');var pkgSelect=byId('jgwo-package');fillSelect(stateSelect,parseList(JGWO.settings.state_list));(function initPackages(){if(!pkgSelect)return;var priceInp=document.getElementById('jgwo-price');var raw=(JGWO&&JGWO.meta&&JGWO.meta.package_options)?JGWO.meta.package_options:'';var lines=raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);pkgSelect.innerHTML='<option value="">-- Select Package --</option>';lines.forEach(function(line){var parts=line.split(/\s*\|\s*/);var label=(parts[0]||'').trim();var numeric=(parts[1]||'').replace(/\D+/g,'');if(!label)return;var opt=document.createElement('option');opt.value=label;opt.setAttribute('data-price',numeric);opt.textContent=label+(numeric?' (₦'+Number(numeric).toLocaleString()+')':'');pkgSelect.appendChild(opt)});function syncPrice(){var p='';if(pkgSelect.selectedIndex>0){p=pkgSelect.options[pkgSelect.selectedIndex].getAttribute('data-price')||''}
if(priceInp)priceInp.value=p}
pkgSelect.addEventListener('change',syncPrice);syncPrice()})();var colourField=byId('jgwo-colour-field');var colourSelect=byId('jgwo-colour');var colours=parseLines(JGWO.meta.colour_options||'');if(colours.length>0&&colourSelect){fillSelect(colourSelect,colours);if(colourField){colourField.style.display=''}}
var dt=lagosNow();byId('jgwo-date').value=dt.date;byId('jgwo-time').value=dt.time;byId('jgwo-webhook-url').value=JGWO.meta.webhook_url||'';byId('jgwo-product-name').value=JGWO.meta.product_name||'';byId('jgwo-admin-wa').value=JGWO.meta.admin_whatsapp||'';byId('jgwo-prefill').value=JGWO.meta.prefilled_message||'';btn.addEventListener('click',function(e){e.preventDefault();if(JGWO.settings.fire_ic==='1'&&window.JGWO_Pixel){window.JGWO_Pixel.fireIC()}
modal.setAttribute('aria-hidden','false');document.body.classList.add('jgwo-lock');var releaseModalTrap=trapFocus(modal);var closeBtn=modal.querySelector('.jgwo-close');if(closeBtn)closeBtn.focus()});modal.addEventListener('click',function(e){if(e.target.classList.contains('jgwo-close')){modal.setAttribute('aria-hidden','true');document.body.classList.remove('jgwo-lock');return}
if(e.target===modal){modal.setAttribute('aria-hidden','true');document.body.classList.remove('jgwo-lock')}});var serious=document.getElementById('jgwo-serious');if(serious)serious.addEventListener('click',function(){modal.setAttribute('aria-hidden','true');formPanel.setAttribute('aria-hidden','false');document.body.classList.add('jgwo-lock');var releaseFormTrap=trapFocus(formPanel);try{formPanel.scrollIntoView({behavior:'smooth',block:'end'})}catch(e){}});var notReady=document.getElementById('jgwo-notready');if(notReady)notReady.addEventListener('click',function(){modal.setAttribute('aria-hidden','true')});formPanel.addEventListener('click',function(e){if(e.target.classList.contains('jgwo-close')){formPanel.setAttribute('aria-hidden','true');document.body.classList.remove('jgwo-lock');return}
if(e.target===formPanel){formPanel.setAttribute('aria-hidden','true');document.body.classList.remove('jgwo-lock')}});var phoneInput=byId('jgwo-phone');if(phoneInput){phoneInput.addEventListener('input',function(){var v=phoneInput.value.replace(/[^\d+]/g,'');if(v.indexOf('+')>0)v=v.replace(/\+/g,'');phoneInput.value=v;phoneInput.setCustomValidity(isValidNGPhone(v)?'':'Enter a valid NG phone (+234XXXXXXXXXX or 0XXXXXXXXXX)')})}
var form=document.getElementById('jgwo-order-form');form.addEventListener('submit',function(e){e.preventDefault();var submitBtn=byId('jgwo-submit');var now=Date.now();var last=parseInt(sessionStorage.getItem('jgwo_last_submit')||'0',10);if(now-last<5000){alert('Please wait a few seconds before submitting again.');return}
sessionStorage.setItem('jgwo_last_submit',String(now));submitBtn.disabled=!0;if(!byId('jgwo-package').value){alert('Please select a package.');submitBtn.disabled=!1;return}
if(!isValidNGPhone(byId('jgwo-phone').value)){alert('Please enter a valid Nigerian phone number (e.g., +2348012345678 or 08012345678).');submitBtn.disabled=!1;return}
var payload={event:'order_intent',source:'jg-whatsapp-order',webhook_url:byId('jgwo-webhook-url').value,product:{name:byId('jgwo-product-name').value,package:byId('jgwo-package').value,colour:(byId('jgwo-colour')?byId('jgwo-colour').value:''),price:byId('jgwo-price')?byId('jgwo-price').value:''},customer:{full_name:byId('jgwo-name').value,phone:byId('jgwo-phone').value,email:byId('jgwo-email').value,address:byId('jgwo-address').value,state:byId('jgwo-state').value},meta:{date_submitted:byId('jgwo-date').value,time_submitted:byId('jgwo-time').value}};var doWebhook=payload.webhook_url&&payload.webhook_url.length>0;var webhookPromise=Promise.resolve({ok:!1});if(doWebhook){webhookPromise=fetch(JGWO.rest_url,{method:'POST',headers:{'Content-Type':'application/json','X-WP-Nonce':JGWO.nonce},body:JSON.stringify(payload)}).catch(function(){return{ok:!1}})}
var adminWA=byId('jgwo-admin-wa').value.replace(/\D+/g,'');if(!adminWA){alert('Admin WhatsApp number is not configured for this page. Please contact support.');submitBtn.disabled=!1;return}
var prefill=byId('jgwo-prefill').value||'';var map={product_name:payload.product.name||'',package:payload.product.package||'',colour:(payload.product.colour||''),price:payload.product.price||'',full_name:payload.customer.full_name||'',phone:payload.customer.phone||'',email:payload.customer.email||'',address:payload.customer.address||'',state:payload.customer.state||'',date_submitted:payload.meta.date_submitted||'',time_submitted:payload.meta.time_submitted||''};var template=(JGWO.settings.whatsapp_template||'').trim();var body=template?buildFromTemplate(template,map):'';if(!template){body='Order: '+encodeURIComponent(map.product_name)+'%0A'+'Package: '+encodeURIComponent(map.package)+'%0A'+(map.price?('Price: ₦'+encodeURIComponent(map.price)+'%0A'):'')+(map.colour?('Colour: '+encodeURIComponent(map.colour)+'%0A'):'')+'Name: '+encodeURIComponent(map.full_name)+'%0A'+'Phone: '+encodeURIComponent(map.phone)+'%0A'+'Email: '+encodeURIComponent(map.email)+'%0A'+'Address: '+encodeURIComponent(map.address)+'%0A'+'State: '+encodeURIComponent(map.state)+'%0A'+'Date: '+encodeURIComponent(map.date_submitted)+'%0A'+'Time: '+encodeURIComponent(map.time_submitted)}
if(prefill)body=encodeURIComponent(prefill)+'%0A%0A'+body;var waURL='https://wa.me/'+adminWA+'?text='+body;if(JGWO.settings.fire_purchase==='1'&&window.JGWO_Pixel){window.JGWO_Pixel.firePurchase()}
window.open(waURL,'_blank');try{if(formPanel){formPanel.setAttribute('aria-hidden','true')}
document.body.classList.remove('jgwo-lock');if(btn&&typeof btn.focus==='function')btn.focus()}catch(e){}
webhookPromise.finally(function(){submitBtn.disabled=!1;try{console.log('Webhook attempted; continuing user flow.')}catch(e){}})})})();(function(){function setVh(){try{var h=(window.visualViewport&&window.visualViewport.height)?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty('--jgwo-vh',(h/100)+'px')}catch(e){}}
setVh();window.addEventListener('resize',setVh);if(window.visualViewport){window.visualViewport.addEventListener('resize',setVh)}})()